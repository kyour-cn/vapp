"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){var n=function(n){for(var o in n)this.conf[o]=n[o];return"WebSocket"in e?this.log("Your browser support WebSocket!"):this.log("Your browser doesn't support WebSocket!"),window.EasySocketConn=this,setInterval(this.sendHeart,1e3*this.conf.heartSleep),this};n.prototype={version:"0.0.3",conf:{url:"",heart:"heart",heartSleep:60,sessionName:"",sessionId:"",ajaxToken:"ES_TOKEN",reconn:!0,eventKey:"cmd",debug:!1},socket:null,createTime:0,reConnData:[],listener:{},ajaxQueue:{},event:{open:null,close:null},log:function(e){this.conf.debug&&console.log(e)},init:function(e){this.event.open=e,this.log("Websocket Connecting: "+this.conf.url);var n=new WebSocket(this.conf.url);this.socket=n,n.onopen=this.onOpen,n.onmessage=this.onMessage,n.onclose=this.onClose},addListener:function(e,n){this.listener[e]=n},send:function(e,n){n&&this.reConnData.push(e),"object"==(void 0===e?"undefined":_typeof(e))&&(this.conf.sessionId?e[this.conf.sessionName]=this.conf.sessionId:this.conf.sessionName&&(e[this.conf.sessionName]=this.sessionId()),e=JSON.stringify(e)),this.socket.send(e)},ajax:function(e,n){var o=this.randomString(),t={data:e.data?e.data:{}};t[this.conf.ajaxToken]=o,t[this.conf.eventKey]=e[this.conf.eventKey];try{this.send(t)}catch(e){return void n(null,{code:300,message:e})}this.ajaxQueue[o]=n,e.outtime&&setTimeout(function(){var e=window.EasySocketConn;if(e.ajaxQueue[o]){var n="Response timeout.";e.log(n),e.ajaxQueue[o](null,{code:1,message:n}),delete e.ajaxQueue[o]}},1e3*e.outtime)},sendHeart:function(){var e=window.EasySocketConn;if(null!==e.socket)if("function"==typeof e.conf.heart.data){var n={};for(var o in e.conf.heart)n[o]=e.conf.heart[o];n.data=e.conf.heart.data(),e.send(n)}else e.send(e.conf.heart)},onOpen:function(){var e=window.EasySocketConn;e.log("Websocket Connected.");for(var n in e.reConnData)e.send(e.reConnData[n]);"function"==typeof e.event.open&&(e.event.open(),e.event.open=null)},onMessage:function(e){var n=window.EasySocketConn,o=n.deJson(e.data);if(!1===o)return void(n.conf.debug&&n.log("Websocket Raw Dataï¼š"+e.data));var t=n.conf.ajaxToken;if(o[t]&&n.ajaxQueue[o[t]])return n.ajaxQueue[o[t]](o),void delete n.ajaxQueue[o[t]];o[n.conf.eventKey]&&n.listener[o[n.conf.eventKey]]&&n.listener[o[n.conf.eventKey]](o)},onClose:function(){var e=window.EasySocketConn;e.socket=null,"function"==typeof e.event.close&&e.event.close(),e.conf.reconn&&(e.log("Websocket Disconnected, reconnecting..."),setTimeout(function(){e.log("Websocket Disconnected, reconnecting..."),e.init()},1e3))},deJson:function(e){if("string"==typeof e)try{var n=JSON.parse(e);if("object"==(void 0===n?"undefined":_typeof(n))&&n)return n}catch(e){return!1}return!1},randomString:function(e){e=e||32;for(var n="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",o=n.length,t="",s=0;s<e;s++)t+=n.charAt(Math.floor(Math.random()*o));return t},sessionId:function(){for(var e=this.conf.sessionName,n=document.cookie.split("; "),o=0;o<n.length;o++){var t=n[o].split("=");if(t[0]==e)return t[1]}return""}},e.EasySocket=n,e.EasySocketConn=null}(window);